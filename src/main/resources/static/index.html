<!DOCTYPE html>
<html>
<head>
    <title>Fake GPS Map & Logs</title>
    <meta charset="utf-8" />

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <!-- Bootstrap CSS -->
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />

    <style>
        #map { height: 100vh; width: 100%; }
        pre { background-color: #f8f9fa; padding: 10px; height: 20vh; overflow-y: auto; }
        .btn-custom { margin-top: 10px; }
    </style>
</head>
<body class="container-fluid">



<div class="row">


    <!-- Colonna mappa -->
    <div class="col-md-7">
        <div id="map"></div>

    </div>

    <!-- Colonna log -->
    <div class="col-md-5">
        <h2 class="my-4">Fake GPS Sender & Maps</h2>
        <button class="btn btn-success btn-custom" onclick="startProcess()">Start BPMN Process</button>
        <button class="btn btn-primary btn-custom" onclick="startSending()">Start GPS</button>
        <button class="btn btn-danger btn-custom" onclick="resetAll()">Reset</button>
        <h2 class="my-4">BPMN Monitor <span id="processId"></span></h2>
        <h4>Task Logs</h4>
        <pre id="taskLogBox"></pre>
        <h4>Movement Logs</h4>
        <pre id="movementLogBox"></pre>
        <h4>GPS Logs</h4>
        <pre id="gpsLogBox"></pre>


    </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- Bootstrap JS (opzionale, se non serve interazione modale puoi omettere) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>

    const initialLat = 43.142631;
    const initialLon = 13.078142;

    // Inizializza mappa
    const map = L.map('map').setView([initialLat, initialLon], 18);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
    }).addTo(map);

    let marker = L.marker([initialLat, initialLon]).addTo(map);
    marker.bindTooltip("Andrea Cataluffi", {permanent: true, direction: "center"});

    const polygon = L.polygon([
        [43.139775, 13.068940],
        [43.139618, 13.069082],
        [43.139401, 13.068624],
        [43.139571, 13.0684711]
    ], {color: "#ff7800"}).addTo(map);
    polygon.bindTooltip("CS@Unicam", {permanent: true, direction: "center"});

    function updateMarker(lat, lon, inside = false) {
        marker.setLatLng([lat, lon]);
        map.panTo([lat, lon]);
        if(inside) map.fitBounds(polygon.getBounds());
    }



    function startSending() {
        fetch("http://localhos" +
            "t:8081/api/gps/start", { method: "POST" })
            .then(() => {
                gpsInterval = setInterval(fetchGpsAndUpdate, 1000);
                console.log("GPS sending started")
            })
            .catch(err => console.error("Failed to start GPS", err));
    }

    const processIdElement = document.getElementById("processId");
    function startProcess() {
        clearLogs();
        fetch("http://localhost:8080/api/process/start?processId=Process_0yudeo4", { method: "POST" })
            .then(response => response.json())
            .then((res) => {

                processIdElement.textContent = "- PID: " + res.pid;
                logInterval = setInterval(fetchLogs, 10);
                console.log("Process started")
            } )
            .catch(err => console.error("Failed to start process", err));
    }

        function fetchLogs() {
            fetch("http://localhost:8080/api/logs")
                .then(response => response.json())
                .then(data => {
                    const taskLogBox = document.getElementById("taskLogBox");
                    const gpsLogBox = document.getElementById("gpsLogBox");
                    const movementLogBox = document.getElementById("movementLogBox");

                    let taskLogs = [];
                    let gpsLogs = [];
                    let movementLogs = [];

                    data.forEach(line => {
                        if (line.startsWith("TASK")) {
                            taskLogs.push(line);
                        } else if (line.startsWith("[GPS Received]")) {
                            gpsLogs.push(line);
                        } else if (line.startsWith("[MOVEMENT: Wait state]") || line.startsWith("[Participant Position]")) {
                            movementLogs.push(line);
                        } else if (line.startsWith(">>> Task type:")) {
                            // opzionale: se vuoi anche questo nei movement
                            movementLogs.push(line);
                        }
                    });

                    taskLogBox.textContent = taskLogs.join('\n');
                    gpsLogBox.textContent = gpsLogs.join('\n');
                    movementLogBox.textContent = movementLogs.join('\n');

                    // scroll automatico in fondo
                    taskLogBox.scrollTop = taskLogBox.scrollHeight;
                    gpsLogBox.scrollTop = gpsLogBox.scrollHeight;
                    movementLogBox.scrollTop = movementLogBox.scrollHeight;
                })
                .catch(err => console.error("Failed to fetch logs", err));
        }

    function clearLogs() {
        processIdElement.textContent = "";

        fetch("http://localhost:8080/api/logs/clear", { method: "POST" })
            .then(() => {
                document.getElementById("taskLogBox").textContent = ""
                document.getElementById("gpsLogBox").textContent = ""
                document.getElementById("movementLogBox").textContent = ""
            })
            .catch(err => console.error("Failed to clear logs", err));
    }

    let logInterval = null;
    let gpsInterval = null;


    function fetchGpsAndUpdate() {
        fetch("http://localhost:8081/api/gps/current")
            .then(response => response.json())
            .then(data => {
                if (data.lat && data.lon) {
                    updateMarker(data.lat, data.lon, data.inside);
                }

                if (data.inside) {
                    clearInterval(logInterval);
                    clearInterval(gpsInterval);
                }
            })
            .catch(err => console.error("Failed to fetch current GPS", err));
    }



    function resetAll() {
        // Ferma intervalli se attivi
        if (logInterval) {
            clearInterval(logInterval);
            logInterval = null;
        }
        if (gpsInterval) {
            clearInterval(gpsInterval);
            gpsInterval = null;
        }

        clearLogs();
        updateMarker(initialLat, initialLon);
        map.setView([initialLat, initialLon], 18);

        console.log("Reset completato: log puliti e marker riposizionato");
    }

</script>
</body>
</html>
